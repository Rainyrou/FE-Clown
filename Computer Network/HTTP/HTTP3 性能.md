![[Pasted image 20231109214930.png]]

##### 1. 基于 QUIC 的多路复用:

QUIC（Quick UDP Internet Connections）是一个基于 UDP 的伪 TCP + TLS + HTTP/2 的多路复用协议

UDP 是不管顺序和丢包的，也没有依赖关系，它无需连接，自然也不需要握手挥手的过程，因此天然比 TCP 快。它是不可靠传输协议，但基于 UDP 的 QUIC 协议可以实现类似 TCP 的可靠性传输（具有连接管理、拥塞窗口、流量控制的网络特性）

###### 无队头阻塞

HTTP/3 使用基于 UDP 的 QUIC 协议，它解决了 HTTP/2 中 TCP 协议可能导致的队头阻塞问题。在 HTTP/2 中，即使多个请求可以同时在一个连接上并行发送，但如果一个数据包丢失，整个 TCP 连接都会受到影响，直到丢失的数据包被重传。QUIC 改进了这一点，因为它将多个流多路复用到一个 UDP 连接上，如果一个流的数据包丢失，只会影响该流，而其他流不会受到影响，这降低了延迟

不过 QUIC 协议能保证数据包的可靠性，每个数据包都用唯一序号标识。当某个流中的一个数据包丢失，即使该流的其他数据包到达，数据也无法被 HTTP/3 读取，直到 QUIC 重传丢失的报文为止。但其他流的数据报文只要被完整接收，HTTP/3 就可以读取到对应流的数据

###### 更快的连接建立

对于 HTTP/1 和 HTTP/2，TCP 和 TLS 是分层的，分别属于内核实现的传输层、openssl 库实现的表示层，因此它们难以合并，需要分批次握手，先 TCP 后 TLS

HTTP/3 在传输数据前需要 QUIC 握手，但此握手过程只需要 1 RTT，握手是为了确认双方的连接 ID，连接迁移是基于连接 ID 实现的

但 HTTP/3 的 QUIC 内部包含了 TLS，它在自己的帧里携带 TLS 的记录，而 QUIC 使用的是 TLS1.3，因此仅需 1 个 RTT 便可同时完成建立连接与密钥协商，甚至在第二次连接时，应用数据包可以和 QUIC 握手信息（连接信息 + TLS 信息）一同发送，达到 0 RTT 的效果

###### 连接迁移

QUIC 没有用四元组的方式来绑定连接，而是通过连接 ID 来标记通信两端，客户端和服务器各自选择一组 ID 来自我标记，因此移动设备的网络变化后，即 IP 地址变化，只要仍有上下文信息，就可以复用原连接，消除重连成本，达到连接迁移的功能

##### 2. QPack:

- HTTP/3 使用 QPack 算法进行头部压缩，这是为了适应 QUIC 的无阻塞特性而设计的。即使一些数据包丢失，头部信息也不会被阻塞，因为 QPack 允许独立解码头部字段。QPack 也采用静态表、动态表及 Huffman 编码

HTTP/3 也采用二进制帧的结构，不同在于 HTTP/2 的二进制里需要定义 Stream，而 HTTP/3 无需定义，直接使用 QUIC 里的 Stream。HTTP/3 帧头只有两个字段: 类型和长度

根据类型，大致可分为数据帧和控制帧，HEADERS （HTTP 头部）和 DATA （HTTP 包体）属于数据帧

传输 HTTP 消息时使用的是双向流，而 QUIC 有两个特殊的单向流（只有一端可以发送消息），其用法：
* QPACK Encoder Stream，用于将一个字典（key-value）传递给对方
* QPACK Decoder Stream，用于响应对方，告诉它刚发的字典已更新到自己本地的动态表了，后续可以使用这个字典进行编码

这两个单向流用来同步双方的动态表，编码方收到解码方更新确认的通知后，才使用动态表编码 HTTP 头部

##### 3. 连接建立:

- QUIC 减少了新连接建立的时间。传统的 HTTPS 连接需要先进行 TCP 三次握手，然后是 TLS 握手，共需要 1.5 RTT（往返时间）。QUIC 直接把以往的 TCP 和 TLS/1.3 的 6 次交互合并成 3 次，即仅需要 1 轮 RTT，这对于建立或恢复连接都大大降低了延迟

##### 4. TLS 1.3:

- QUIC 内置了 TLS 1.3，这是较新的传输层安全协议，它提供比 TLS 1.2 更快的握手速度和安全性。这是因为 TLS 1.3 移除了一些不安全的旧特性，简化了协议

##### 5. FEC 和连接迁移:

- QUIC 支持前向纠错机制，即使在无需等待重传的情况下也能恢复丢失的数据包。此外，QUIC 支持连接迁移，即使客户端 IP 发生变化也能维持连接

这些优化使得 HTTP/3 在性能上有了显著提升，特别是在高延迟/移动网络上
