###### 性能优化

1. DNS：基于 HTTP2/3 多路复用突破域名并发限制，将所有 CDN 资源收敛于 2-3 个核心域名（主站 + CDN + 备用 CDN）；通过 `<link rel="dns-prefetch">` 或前置页面预解析 DNS，减少首屏 DNS 查询耗时

2. HTTP：全链路开启 HTTP/2/3，突破单域名 6 连接并发限制，通过 HTTP2 Server Push 推送 CSS，减少 CDN 建连与数据往返时间，支撑首屏 DOM + CSS 快速渲染；HTTP3 QUIC 增强

3. HTML：HTML 不设缓存并压缩、移除无用代码，服务端无需等待全量计算，流式下发 JavaScript 和 CSS 引用，优先首屏数据并通过 HTTP2 Push 分批传输非首屏数据，通过 `preload` 预加载静态资源，并行服务端计算逻辑，减少"TTFB + 资源等待"耗时

4. SSR：网关提前获取前端依赖的后端数据，随 SSR 直出，重构前后端同源 UI 层，解耦 UI 与数据

5. 静态资源：资源能在编译时决定的逻辑就不要等到运行时，资源能通过 CDN 加载就不要置于动态服务端；缓存策略为长缓存 + MD5，将不频繁更新的文件打包为同一 Bundle，提高资源缓存命中率；CDN 通过本地探测选择最优节点，将结果存储于 Cookie 关联构建；资源优化如 CDN 或对象存储的图片自适应压缩 + WebP 格式 + 渐进式加载 + 动态调整、静态分析 Tree Shaking + Chrome 覆盖率检测移除无用代码 + Coverage  面板检测绿色（首屏）和红色（非首屏）；通过 **`prefetch`**、**`preload`**、iframe 和客户端容器预加载，和 Hybrid 应用 WebView 保活/实例复用；通过本地多版本缓存和代理按需加载 WebAssembly/大型 SDK；通过对象池预缓存高频对象、内存池预分配固定大小内存块

6. 数据获取：后端预处理数据，前端无需大规模转换；关键数据由网关直接注入，避免前端向后端重新请求；非关键数据存储于前端本地缓存，接口预请求

7. 代码执行：首屏代码阻塞式密集执行，非首屏代码延迟/按需/闲时加载（图片路由组件懒加载）；通过 Worker 拆分多线程和长任务、防抖节流、减少重绘回流、Proxy 延迟执行

8. 业务链路优化

9. 架构：通过"单向依赖分层架构 + UI/逻辑分离 + 插件化 + 多端分离"实现性能防腐；配套"开发分支监控 + CI 流水线监控 + 性能/稳定性看板 + SRE 体系"，形成性能问题发现 - 优化 - 闭环的全链路管理

###### 性能上报

数据采集：

- 环境信息（机型设备、操作系统和浏览器内核） -> 排查问题时定位错误来源
- 性能信息（网络层面和页面层面） -> 发现影响用户体验的性能问题
- 错误信息（未被捕获的全局运行时错误、未被处理的 rejected Promise 和静态资源加载错误） -> 研发及时响应修复问题
- 业务信息（用户行为和页面交互） -> 产品使用情况

网络层面指标：

- 重定向耗时：`redirectEnd - redirectStart`
- DNS 解析耗时：`domainLookupEnd - domainLookupStart`
- TCP 连接耗时：`connectEnd - connectStart`
- SSL 耗时：`connectEnd - secureConnectionStart`
- TTFB（Time To First Byte）网络请求耗时：`responseStart - requestStart`
- 数据传输耗时：`responseEnd - responseStart`
- 资源加载耗时：`loadEventStart - domContentLoadedEventEnd`

![[1708767210268.png]]

![[Pasted image 20240224173357.png]]

页面层面指标：

- FP（First Paint）：页面首次绘制时间 -> Performance
- FCP（First Contentful Paint）：页面首次内容绘制时间 -> Performance
- LCP（Largest Contentful Paint）：页面最大内容绘制时间 -> Performance Insights
- FMP（First Meaningful Paint）：页面首次有意义绘制时间
- DCL（DomContentLoaded）：DOM 内容加载完成时间
- L（onLoad）：页面完全加载的时间
- TTI（Time to Interactive）：页面可交互的时间
- FID（First Input Delay）：用户首次交互到页面响应的时间

自动采集：创建 `PerformanceObserver` 实例，注册回调，监听目标指标，在指标触发时执行回调，接收 `entries` 参数，提取核心数据存储于内存池，批量上报
手动埋点：定义埋点工具函数，在页面加载完成、组件挂载后和销毁前、接口请求、用户交互和浏览器空闲时调用

传输方式：

- 1x1 像素 GIF：创建 `<img>` 元素，将其 `src` 指向分析端点，以性能指标为查询参数，浏览器发送 GET 请求获取该图片，兼容性好，局限于 GET 请求且 URL 长度存在限制，有数据截断风险，无法处理响应
* `navigator.sendBeacon`：POST 异步请求，由浏览器处理，页面销毁时也能发送，局限于 POST 请求且数据大小存在限制，无法自定义请求头部，无法处理响应
* `fetch` + `keepalive: true`：支持 HTTP 所有方法，无数据大小限制，自定义请求头部，处理服务端响应
