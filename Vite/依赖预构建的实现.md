Vite 的 dependency pre-bundling 用于 `node_modules` 中的第三方依赖，旨在解决浏览器对原生 ESM 支持时的一些限制和性能问题

1. 兼容性：许多 npm 包仍使用 CommonJS 或 UMD 模块格式，这些格式不是浏览器原生支持的 ESM 格式。预构建将它们转换为 ESM，使得它们可以直接在现代浏览器中运行
2. 性能优化：直接在浏览器中加载数百个小模块会导致大量的 HTTP 请求，从而影响 Vite dev server 的响应速度。通过预构建，Vite 能将多个依赖合并为少数几个模块，减少 HTTP 请求的数量

###### 实现机制

1. 侦测和分析：当 Vite 启动 dev server 时，它首先扫描项目的入口文件和相关代码，分析 `import` 语句来确定需要预构建的依赖。
2. Esbuild 预构建：Vite 利用 Esbuild 的编译能力来预构建依赖，Esbuild 以其极快的编译速度闻名于世，它可以迅速处理大量依赖，这个预构建过程包括将 CommonJS 或 UMD 模块转换为 ESM，及进行必要的语法转换
3. 优化和缓存：预构建的结果会被 Tree-Shaking 和缓存，Vite 将这些预构建的依赖保存在缓存中，默认位于`node_modules/.vite`目录，在后续的开发中可以直接使用这些缓存，无需重新预构建
4. 按需加载：即使在预构建了依赖后，Vite 仍利用 ESM 的动态导入特性来按需加载模块，确保只有当模块被请求时才会被加载

###### 底层原理

- 模块解析：Vite 使用自己的解析逻辑来确定哪些依赖需要被预构建。这一过程考虑了依赖的版本，避免不同版本的依赖被错误合并
- 模块转换：通过 Esbuild 和 `@rollup/plugin-commonjs` 等预处理工具，Vite 将依赖转换为 ESM，此过程包括处理特殊的模块解析逻辑、环境变量替换和条件导入等
- 高效缓存：Vite 设计了一套高效的缓存机制来存储预构建的结果，它们会在依赖未更改时被复用，只有在`package.json` 中的依赖版本发生变化或 Vite 配置更改时，预构建过程才会重新触发


