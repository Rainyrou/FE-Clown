- 解析阶段：通过基于正则表达式的 HTML 解析器将模板字符串（HTML 标签、属性、指令、注释、文本节点和插值表达式等）转换为 AST
- 优化阶段：对 AST 进行静态分析，标记静态节点并将其提升到渲染函数的外部，这些节点在后续重新渲染时被直接跳过
- 代码生成阶段：将优化后的 AST 转换成最终的渲染函数

1. 模板编译入口：`initMixin` 函数为 Vue.prototype 上添加一个 `_init` 方法，用于初始化 Vue 实例，具体来说，`this.$options` 存储初始化 Vue 实例时传入的所有选项，`initState(vm)` 初始化 Vue 实例的状态，如通过 `Object.defineProperty` 建立响应式系统、挂载 `computed` 与 `method`、`watch/event` 事件回调。`Vue.prototype.$mount` 将模板编译成渲染函数，挂载到指定的 DOM 上，具体来说，通过 `document.querySelector(el)` 找到 DOM 元素，检查是否有 `render` 函数，若有直接跳到模板编译阶段，使用该函数渲染 DOM，若没有 `render` 函数但有 `template` 模板，直接使用该模板，若既没有 `render` 函数也没有` template` 模板，但指定挂载点 `el`，将挂载点的外部 HTML 作为模板。`compileToFunctions(template)` 将模板字符串转换成渲染函数，基于正则表达式解析模板中的指令、插值表达式等，输出渲染函数
2. `compileToFunctions`：`parse` 函数解析 HTML 模板字符串，将其转换成 AST，`optimize` 函数遍历 AST 并为每个静态节点添加标记，`generate` 函数遍历 AST 并将每个节点转换成渲染函数的代码字符串如元素节点转换为 `_c`（createElement 的别名），文本节点转换为 `_v`（createTextVNode 的别名），表达式被转换为 `_s`（JSON.stringify 的别名）。最后 `new Function` 创建一个新函数，使用 `with` 语句来改变作用域为 `this`，使得在模板中可以直接访问到实例的属性，之后调用渲染函数可使用 `call` 改变 `this`，使得在模板中可以直接访问到实例的数据
3. 解析 HTML 并生成 AST：正则表达式 `ncname` 和 `qnameCapture` 匹配 XML 和 HTML 标签名，`startTagOpen` 和 `endTag` 匹配标签的开头和结尾，`attribute` 匹配标签内的属性，`createASTElement` 函数根据标签名和属性列表创建一个 AST 节点，其包括 `tag` 标签名、`type` 节点类型、`children` 子节点数组、`attrs` 属性列表 和 `parent` 父节点引用，`handleStartTag` 和 `handleEndTag` 处理开始标签和结束标签，对于开始标签，创建一个新的 AST 节点，并将其推入堆栈（模拟 DOM 树的 DFS），对于结束标签，从堆栈中弹出最近的节点，并将其设置为当前节点的子节点，同时更新当前父节点为栈顶元素，而 `handleChars` 处理文本节点，将文本内容添加到当前父节点的 `children` 数组中，`parse` 函数是整个解析过程的控制中心，它通过循环读取 HTML 模板内容，根据当前的内容是标签还是文本，调用相应的处理函数，`parseStartTag` 解析开始标签，包括标签名和属性，逐个匹配所有属性，直到遇到标签的闭合部分，`advance` 消费已解析的模板字符串部分，确保每次循环处理的均为尚未解析的字符串部分
4. 根据 AST 重新生成代码：在 `gen` 函数中，当节点类型为文本时，首先通过正则表达式 `defaultTagRE` 检查文本是否包含花括号表达式，若有，分割文本，区分普通文本和表达式文本，通过 `exec` 方法循环匹配文本，根据匹配到的索引位置切分字符串，提取出普通文本和表达式，使用 `JSON.stringify` 将普通文本转换为 JSON 格式字符串，而表达式则被包装在 `_s` 方法中，最终这些文本片段通过 `+` 连接，生成一个完整的文本节点表示。`genProps` 函数将节点的属性转换成字符串，对于普通属性，直接将属性名和值转为字符串格式；对于样式属性，则进一步解析为对象形式，以支持 Vue 的内联样式绑定。`getChildren` 函数递归调用 `gen` 函数，为每个子节点生成对应的渲染函数。`generate` 将一个元素及其所有子元素转换为渲染函数代码。它构造 Vue 的虚拟 DOM 节点创建函数 `_c` 的调用
