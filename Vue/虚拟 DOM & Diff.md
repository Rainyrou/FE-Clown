![[Pasted image 20240504202501.png]]

![[Pasted image 20240504202448.png]]

虚拟 DOM 为一个树形结构的 JavaScript 对象，Vue 虚拟 DOM 的实现参考 `snabbdom.js` 和 `inferno.js`，其核心是在 JavaScript 模拟 DOM 树，它为解决浏览器性能问题应运而生，状态更新反映在虚拟 DOM 上，操作内存中的 JS 对象显然更快，等批量更新后，将虚拟 DOM 映射为真实 DOM，再由浏览器渲染，通过 Diff 算法比较新旧虚拟 DOM 树中节点的差异，并根据差异对真实 DOM 进行最小量更新。虚拟 DOM 抽象浏览器渲染过程，实现跨平台的能力，不再局限于浏览器 DOM，也可以是小程序、Android 和 iOS 的原生组件等

`h` 函数即 Vue `render` 方法中的 `createElement` 和 `React.createElement`，Vue 通过 vue-loader 将 template 转换为 `h` 函数，React 通过 babel 将 JSX 转换为 `h` 函数

Vue2 的 Diff 算法采用双指针比较新旧虚拟节点的子节点列表，同层级 vnode 进行比较，若新的 vnode 存在而旧的不存在，则创建新节点，反之，则删除旧节点。在处理子节点时维护新前、新后、旧前和旧后四个指针进行比较，尽可能地复用现有节点，避免不必要的 DOM 操作

1. 头头比较（oldStartVnode 与 newStartVnode）：如果相同，则指针都向后移
2. 尾尾比较（oldEndVnode 与 newEndVnode）：如果相同，则指针都向前移
3. 头尾比较（oldStartVnode 与 newEndVnode）：如果相同，表明旧头节点应该移动到尾部，相应指针调整
4. 尾头比较（oldEndVnode 与 newStartVnode）：如果相同，表明旧尾节点应该移动到头部，相应指针调整

以上步骤循环进行，直到新旧节点的开始或结束指针交叉，结束后，若新旧节点列表长度不同，进行额外的节点增删操作

- Vue3 对 Diff 算法进行优化，增加更多静态标记，在编译阶段，Vue3 编译器检测并标记出静态根节点，这些节点及其子树在后续的更新过程中被直接跳过。Vue3 使用 Map 来跟踪动态子节点的索引，引入最长递增子序列算法优化含有 `v-for` 指令的列表渲染，通过计算新旧虚拟节点的 LIS 确定哪些元素无需移动，减少布局重排和重新渲染的开销

1. 创建一个数组 `p` 用于记录每个元素的前驱节点之索引，创建一个结果数组 `result` 用于记录最长递增子序列的索引
2. 遍历列表，对于每个元素，使用二分查找在 `result` 中找到第一个大于当前元素的位置 `i`
3. 若找到，更新 `result[i]` 为当前元素的索引并更新 `p` 数组，否则将当前元素的索引添加到 `result` 的末尾
4. 最后使用 `p` 数组反向追踪最长递增子序列

###### 判断元素的类型变化

1. `tag` 标签名：若两个节点的标签名不同，如一个是 `<div>` 另一个是 `<span>`，Vue 认为它们是不同类型的元素
2. `key` 属性：`key` 用于为列表中的每个节点提供唯一标识，若两个节点的 `tag` 不同但 `key` 不同，Vue 认为它们是不同类型的元素
3. 节点类型：节点可以是元素节点、文本节点或组件节点等，若节点的类型不同，Vue 认为它们是不同类型的元素

###### Diff 算法的优点

1. 性能提升：比较新旧虚拟 DOM 树中节点的差异，并根据差异对真实 DOM 进行最小量更新，而非重新渲染整个 DOM 树，减少 DOM 的操作次数
2. 简化代码：直接编写声明式的 UI 代码，无需直接操作 DOM，无需关心如何高效更新 DOM
3. 行为可预测：保证组件的状态变化以可预测的方式反映到 UI 上，使状态管理清晰可控
